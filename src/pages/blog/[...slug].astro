---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '@layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await post.render();

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('vi-VN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}

const shareUrl = Astro.url.toString();
const shareTitle = post.data.title;
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={post.data.heroImage}
  article={true}
  publishedTime={post.data.pubDate.toISOString()}
  modifiedTime={post.data.updatedDate?.toISOString()}
>
  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="reading-progress-bar" style="width: 0%">
  </div>

  <article class="py-12">
    <div class="container mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <!-- Hero Image -->
      {
        post.data.heroImage && (
          <div class="mb-8 overflow-hidden rounded-2xl">
            <img
              src={post.data.heroImage}
              alt={post.data.title}
              class="h-auto w-full object-cover"
              style="max-height: 500px"
            />
          </div>
        )
      }

      <!-- Post Header -->
      <header class="mb-8">
        <div class="flex flex-wrap gap-2 mb-4">
          {
            post.data.tags.map((tag) => (
              <span class="rounded-full bg-primary-100 px-3 py-1 text-sm font-medium text-primary-800 dark:bg-primary-900/30 dark:text-primary-300">
                {tag}
              </span>
            ))
          }
        </div>
        <h1
          class="text-4xl font-bold text-gray-900 dark:text-white md:text-5xl"
        >
          {post.data.title}
        </h1>
        <div
          class="mt-4 flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-400"
        >
          <span>{post.data.author}</span>
          <span>•</span>
          <time datetime={post.data.pubDate.toISOString()}>
            {formatDate(post.data.pubDate)}
          </time>
        </div>
      </header>

      <!-- Share Buttons -->
      <div class="mb-8 flex items-center space-x-4 border-y border-gray-200 py-4 dark:border-gray-800">
        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
          Chia sẻ:
        </span>
        <a
          href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="rounded-lg p-2 text-gray-600 hover:bg-gray-100 hover:text-blue-600 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-blue-400"
          aria-label="Chia sẻ lên Facebook"
        >
          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
            ></path>
          </svg>
        </a>
        <a
          href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareTitle)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="rounded-lg p-2 text-gray-600 hover:bg-gray-100 hover:text-blue-400 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-blue-300"
          aria-label="Chia sẻ lên Twitter"
        >
          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"
            ></path>
          </svg>
        </a>
        <button
          id="copy-link"
          class="rounded-lg p-2 text-gray-600 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white"
          aria-label="Sao chép liên kết"
        >
          <svg
            class="h-5 w-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Post Content -->
      <div
        class="prose prose-lg dark:prose-invert mx-auto max-w-none prose-headings:font-bold prose-a:text-primary-600 dark:prose-a:text-primary-400 prose-img:rounded-lg"
      >
        <Content />
      </div>

      <!-- CTA Section -->
      <div class="mt-12 rounded-2xl bg-gradient-to-r from-primary-500 to-secondary-500 p-8 text-center text-white">
        <h3 class="text-2xl font-bold">Bắt đầu đầu tư ngay hôm nay</h3>
        <p class="mt-2 text-primary-50">
          Tải Fmarket và khám phá cơ hội đầu tư quỹ mở phù hợp với bạn
        </p>
        <a
          href="https://go.behitek.com/fmarket"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-6 inline-block rounded-lg bg-white px-8 py-3 font-semibold text-primary-600 transition-all hover:bg-gray-100"
        >
          Tìm hiểu thêm về Fmarket →
        </a>
      </div>

      <!-- Giscus Comments -->
      <div class="mt-12">
        <h3 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">
          Bình luận
        </h3>
        <div
          class="giscus"
          data-repo="behitek/behivest"
          data-repo-id="R_kgDOQMjAkA"
          data-category="Comments"
          data-category-id="DIC_kwDOQMjAkM4CxSL1"
          data-mapping="pathname"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="top"
          data-theme="preferred_color_scheme"
          data-lang="vi"
          data-loading="lazy"
        >
        </div>
      </div>
    </div>
  </article>

  <script>
    // Reading progress bar
    function updateReadingProgress() {
      const article = document.querySelector('article');
      const progressBar = document.getElementById('reading-progress');

      if (!article || !progressBar) return;

      const scrollTop = window.scrollY;
      const docHeight = article.offsetHeight;
      const winHeight = window.innerHeight;
      const scrollPercent = (scrollTop / (docHeight - winHeight)) * 100;

      progressBar.style.width = Math.min(scrollPercent, 100) + '%';
    }

    window.addEventListener('scroll', updateReadingProgress);
    updateReadingProgress();

    // Copy link button
    const copyButton = document.getElementById('copy-link');
    copyButton?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        alert('Đã sao chép liên kết!');
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });

    // Load Giscus comments
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', 'yourusername/behivest');
    script.setAttribute('data-repo-id', 'YOUR_REPO_ID');
    script.setAttribute('data-category', 'Comments');
    script.setAttribute('data-category-id', 'YOUR_CATEGORY_ID');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'top');
    script.setAttribute('data-theme', 'preferred_color_scheme');
    script.setAttribute('data-lang', 'vi');
    script.setAttribute('crossorigin', 'anonymous');
    script.async = true;

    document.querySelector('.giscus')?.appendChild(script);
  </script>
</Layout>
